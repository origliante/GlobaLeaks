<!doctype html>
<html>
<head>
<meta charset="utf-8">  
</head>
<body>
    <section class="block">
        <p id="keydata">keydata message box</p>
        <form enctype="multipart/form-data" name="submitform" id="submitform">
            <ul>
                <li><label>Key to be validated: </label><br /> <textarea rows="20" cols="80"
                        name="message" id="message"></textarea></li>
            </ul>
            <input type="button" name="submitbutton" id="submitbutton" onclick="return validate_key();" />
            <input type="button" name="submitbutton" id="submitbutton" onclick="return generate_key();" />
        </form>
        <p id="privkey"></p>
        <p id="pubkey"></p>
    </section>
    <script type="text/javascript"
        src="http://github.com/openpgpjs/openpgpjs/releases/download/v0.9.0/openpgp.js"
    ></script>
    <script type="text/javascript"
        src="http://code.jquery.com/jquery-1.11.2.min.js"
    ></script>
    <script type="text/javascript"
        src="/static/FileSaver.js"
    ></script>

    <script type="text/javascript">
        var pgp_message = null;

        function generate_key() {
            // A passphrase must be defined!
            var my_user_id = "John Test <john_test@someserver.com>";
            var my_passphrase = "123qwe";
            var my_key = openpgp
                .generateKeyPair({numBits: 2048, userId: my_user_id, passphrase: my_passphrase})
                .then(function(keyPair) {
                    var pubkeyBlob = new Blob([my_user_id + " Pub Key"], {type: "text/plain;charset=utf-8"});
                    var privkeyBlob = new Blob([my_user_id + " Priv Key"], {type: "text/plain;charset=utf-8"});

                    var zip = new JSZip();
                    var keys = zip.folder("GLKeys");
                    keys.file("privkey.asc", privkeyBlob, {base64: true});
                    keys.file("pubkey.asc", pubkeyBlob, {base64: true});

                    var content = zip.generate({type:"blob"});
                    saveAs(content, "GLKeys.zip");

                    //$('#privkey').text("My private key:\n\n" + keyPair.privateKeyArmored);
                    //$('#pubkey').text("My public key:\n\n" + keyPair.publicKeyArmored);
                });
            return true;
        }


        function validate_key() {
            if (window.crypto.getRandomValues) {
                pgp_message = openpgp.key.readArmored( $('#message').val() );
                if (pgp_message) {
                    $("#keydata").text("Valid PGP file.");
                }
                if (typeof(pgp_message.keys) == 'undefined') {
                    $("#keydata").text("Error, no keys found.");
                    return false;
                }
                keys = pgp_message.keys;

                if ( keys.length > 0 ) {
                    var keydata = "";
                    for (i = 0; i < keys.length; i++) {
                        keydata += JSON.stringify( keys[i], null, '\n' );
                        //for (u = 0; u < key.users) ub_key.keys[i].users[0].userId['userid'] + " Key is valid");
                    }
                    $("#keydata").text(keydata);
                    return true;

                } else {
                    $("#keydata").text("Error, no keys found.");
                }
                return false;

            } else {
                $("#submitbutton").val("browser not supported");
                window.alert("Error: Browser not supported\nReason: We need a cryptographically secure PRNG to be implemented (i.e. the window.crypto method)\nSolution: Use Chrome >= 11, Safari >= 3.1 or Firefox >= 21");
                return false;
            }
        }
    </script>
</body>
</html>
